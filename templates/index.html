<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trade Bot Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            background-color: #f8f9fa;
        }

        .card {
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .status-executed {
            color: #28a745;
            font-weight: bold;
        }

        .status-skipped {
            color: #dc3545;
            font-weight: bold;
        }

        .status-virtual {
            color: #0d6efd;
            /* Bootstrap Primary Blue */
            font-weight: bold;
        }

        .check-pass {
            color: #28a745;
        }

        .check-fail {
            color: #dc3545;
        }

        pre {
            background-color: #f1f1f1;
            padding: 10px;
            border-radius: 5px;
        }
    </style>
</head>

<body>
    <div class="container py-5">
        <h1 class="mb-4 text-center">ü§ñ Trade Bot Dashboard</h1>

        <div class="card">
            <div class="card-header bg-dark text-white d-flex justify-content-between align-items-center">
                <h5 class="mb-0">Run History</h5>
                <div>
                    <button class="btn btn-sm btn-success me-2" onclick="runCheck()">Run Strategy Check</button>
                    <button class="btn btn-sm btn-light" onclick="loadLogs()">Refresh</button>
                </div>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead class="table-light">
                            <tr>
                                <th>Timestamp (IST)</th>
                                <th>Spot Price</th>
                                <th>Status</th>
                                <th>Reason</th>
                                <th>Exit</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="logs-table">
                            <!-- Logs will be inserted here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal for Details -->
    <div class="modal fade" id="detailModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Trade Check Details</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div id="modal-content"></div>
                </div>
            </div>
        </div>
    </div>



    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const formatTime = (isoString) => {
            const date = new Date(isoString);
            return date.toLocaleString();
        };

        const renderCheck = (check, label) => {
            if (!check) return '';
            const statusClass = check.pass ? 'check-pass' : 'check-fail';
            const icon = check.pass ? '‚úÖ' : '‚ùå';
            return `<div class="d-flex justify-content-between mb-2">
                        <span>${label}:</span>
                        <span class="${statusClass}">${icon} ${check.msg || ''}</span>
                    </div>`;
        };

        async function loadLogs() {
            try {
                const response = await fetch('/api/logs');
                const logs = await response.json();
                const tbody = document.getElementById('logs-table');
                tbody.innerHTML = '';

                logs.forEach((log, index) => {
                    const row = document.createElement('tr');
                    let statusClass = 'status-skipped';
                    if (log.status === 'EXECUTED') statusClass = 'status-executed';
                    else if (log.status && log.status.includes('VIRTUAL')) statusClass = 'status-virtual';

                    row.innerHTML = `
                        <td>${formatTime(log.timestamp)}</td>
                        <td>$${log.spot_price.toLocaleString()}</td>
                        <td class="${statusClass}">${log.status}</td>
                        <td>${log.reason || '-'}</td>
                        <td>${log.exit_reason || '-'}</td>
                        <td>
                            <button class="btn btn-sm btn-info me-1" onclick="showDetails(${index})">
                                View
                            </button>
                            <button class="btn btn-sm btn-warning" onclick="sendTelegram(${index})">
                                üì¢ TG
                            </button>
                        </td>
                    `;
                    tbody.appendChild(row);
                });

                window.currentLogs = logs;
            } catch (error) {
                console.error('Error loading logs:', error);
            }
        }

        async function runCheck() {
            if (!confirm("Run manual market analysis?")) return;
            try {
                // Show loading state
                const btn = document.querySelector('button[onclick="runCheck()"]');
                const originalText = btn.innerText;
                btn.innerText = "Running...";
                btn.disabled = true;

                const response = await fetch('/api/run_check', { method: 'POST' });
                const result = await response.json();

                if (response.ok) {
                    alert("Check Complete: " + result.message);
                    loadLogs(); // Refresh logs to see new entry
                } else {
                    alert("Error: " + result.message);
                }

                // Reset button
                btn.innerText = originalText;
                btn.disabled = false;
            } catch (e) {
                alert("Error running check: " + e);
                document.querySelector('button[onclick="runCheck()"]').disabled = false;
            }
        }

        async function sendTelegram(index) {
            if (!confirm("Send this alert to Telegram?")) return;
            try {
                const response = await fetch('/api/send_telegram', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ index: index })
                });
                const result = await response.json();
                alert(result.message);
            } catch (e) {
                alert("Error sending alert: " + e);
            }
        }

        function showDetails(index) {
            const log = window.currentLogs[index];
            const content = document.getElementById('modal-content');

            let detailsHtml = `
                <div class="alert alert-secondary">
                    <strong>Timestamp:</strong> ${formatTime(log.timestamp)}<br>
                    <strong>Spot Price:</strong> $${log.spot_price.toLocaleString()}<br>
                    <strong>Day Range:</strong> $${log.day_low?.toLocaleString()} - $${log.day_high?.toLocaleString()}
                </div>
                
                <h6 class="mt-4">Condition Checks</h6>
                <div class="card p-3 mb-3">
                    ${renderCheck(log.checks.trend, "Trend Filter")}
                    ${renderCheck(log.checks.volatility, "Volatility (HV)")}
                    ${renderCheck(log.checks.premium_balance, "Premium Balance")}
                    ${renderCheck(log.checks.min_premium, "Min Premium")}
                </div>
            `;

            if (log.trade_details) {
                detailsHtml += `
                    <h6 class="mt-4">Potential/Actual Trade Setup</h6>
                    <div class="table-responsive">
                        <table class="table table-bordered table-sm">
                            <thead>
                                <tr>
                                    <th>Leg</th>
                                    <th>Strike</th>
                                    <th>Entry</th>
                                    <th>SL</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>CALL</td>
                                    <td>${log.trade_details.call_strike}</td>
                                    <td>${log.trade_details.call_premium.toFixed(1)}</td>
                                    <td>${log.trade_details.call_sl.toFixed(1)}</td>
                                </tr>
                                <tr>
                                    <td>PUT</td>
                                    <td>${log.trade_details.put_strike}</td>
                                    <td>${log.trade_details.put_premium.toFixed(1)}</td>
                                    <td>${log.trade_details.put_sl.toFixed(1)}</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                `;
            }

            content.innerHTML = detailsHtml;
            new bootstrap.Modal(document.getElementById('detailModal')).show();
        }

        // Load logs on start
        loadLogs();
    </script>
</body>

</html>